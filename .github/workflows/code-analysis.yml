name: Roslyn Analyzer CI

on:
  pull_request:
    branches:
      - main

jobs:
  analyze:
    runs-on: ubuntu-latest
    steps:
    
      - name: üì• Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Ensures all branches are fetched for diff comparison

      - name: üõ†Ô∏è Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '8.0.x'

      - name: üîÑ Fetch Main Branch
        run: |
          git fetch origin main || git fetch origin main:main  # Ensures origin/main exists

      - name: üîç Get Changed C# Files
        id: changed-files
        run: |
          CHANGED_FILES=$(git diff --name-only origin/main...HEAD -- '*.cs' | grep -Ev '^obj/' || true)
          if [[ -z "$CHANGED_FILES" ]]; then
            echo "No C# files changed. Skipping analysis."
            exit 0
          fi
          echo "Changed files: $CHANGED_FILES"
          echo "CHANGED_FILES=$CHANGED_FILES" >> $GITHUB_ENV

      - name: üõ†Ô∏è Restore Dependencies
        run: dotnet restore

      - name: üîé Run Roslyn Analyzers
        run: |
          if [[ -z "$CHANGED_FILES" ]]; then
            echo "No C# files to analyze."
            exit 0
          fi
          dotnet build --no-restore /warnaserror

      - name: ‚úÖ Remove Deprecated FxCopAnalyzers
        run: |
          dotnet remove package Microsoft.CodeAnalysis.FxCopAnalyzers || true
          dotnet add package Microsoft.CodeAnalysis.NetAnalyzers --version latest

      - name: üîÑ Commit Analyzer Fixes (if any)
        run: |
          if git diff --quiet; then
            echo "No changes to commit."
          else
            git config --global user.name 'github-actions[bot]'
            git config --global user.email 'github-actions@github.com'
            git commit -am "Replace FxCopAnalyzers with .NET Analyzers"
            git push
          fi
